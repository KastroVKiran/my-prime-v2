pipeline {
    agent any
    
    tools {
        maven 'Maven'
        jdk 'JDK21'
    }
    
    environment {
        DOCKER_IMAGE = 'kastrov/amazon-prime-clone'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_REGISTRY = 'https://index.docker.io/v1/'
        CONTAINER_NAME = 'prime-video-clone'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/your-org/amazon-prime-clone.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
                junit 'target/surefire-reports/*.xml'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.withRegistry(DOCKER_REGISTRY, 'dockerhub-creds') {
                        // Build and tag image
                        docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        
                        // Also tag as latest
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push('latest')
                    }
                }
            }
        }
        
        stage('Push to DockerHub') {
            steps {
                script {
                    docker.withRegistry(DOCKER_REGISTRY, 'dockerhub-creds') {
                        // Push both tags
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
                        docker.image("${DOCKER_IMAGE}:latest").push()
                    }
                }
            }
        }
        
        stage('Deploy to Docker') {
            steps {
                script {
                    // Stop and remove existing container if running
                    sh '''
                        docker stop ${CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} || true
                    '''
                    
                    // Pull and run new container
                    sh """
                        docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker run -d \
                            --name ${CONTAINER_NAME} \
                            --restart unless-stopped \
                            -p 8080:8080 \
                            -e JAVA_OPTS="-Xms512m -Xmx1024m" \
                            --health-cmd="curl -f http://localhost:8080/ || exit 1" \
                            --health-interval=30s \
                            --health-timeout=3s \
                            --health-retries=3 \
                            --health-start-period=60s \
                            ${DOCKER_IMAGE}:${DOCKER_TAG}
                    """
                    
                    // Wait for container to be healthy
                    timeout(time: 2, unit: 'MINUTES') {
                        waitUntil {
                            sh '''
                                HEALTH_STATUS=$(docker inspect --format="{{.State.Health.Status}}" ${CONTAINER_NAME})
                                [ "$HEALTH_STATUS" = "healthy" ]
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    retry(3) {
                        sh '''
                            echo "Performing health check..."
                            curl -f http://localhost:8080/ || exit 1
                        '''
                    }
                }
            }
        }
        
        stage('Cleanup Old Images') {
            steps {
                script {
                    // Clean up old Docker images (keep last 5)
                    sh '''
                        docker images ${DOCKER_IMAGE} --format "{{.Tag}}" | \
                        grep -E "^[0-9]+$" | \
                        sort -rn | \
                        tail -n +6 | \
                        xargs -I {} docker rmi ${DOCKER_IMAGE}:{} || true
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo 'Docker deployment completed successfully!'
            emailext (
                subject: "SUCCESS: Amazon Prime Clone Docker Deployment - Build ${env.BUILD_NUMBER}",
                body: """Build ${env.BUILD_NUMBER} deployed successfully to Docker.
                
                Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}
                Container: ${CONTAINER_NAME}
                Application URL: http://localhost:8080/
                
                Pull Command:
                docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
                
                Run Command:
                docker run -d -p 8080:8080 ${DOCKER_IMAGE}:${DOCKER_TAG}
                """,
                to: 'devops@example.com',
                from: 'jenkins@example.com'
            )
        }
        failure {
            echo 'Docker deployment failed!'
            script {
                // Log container status for debugging
                sh '''
                    echo "=== Container Status ==="
                    docker ps -a | grep ${CONTAINER_NAME} || echo "Container not found"
                    echo ""
                    echo "=== Container Logs ==="
                    docker logs ${CONTAINER_NAME} --tail 50 || echo "No logs available"
                '''
            }
            emailext (
                subject: "FAILURE: Amazon Prime Clone Docker Deployment - Build ${env.BUILD_NUMBER}",
                body: """Docker deployment for build ${env.BUILD_NUMBER} failed.
                
                Check Jenkins console for details: ${env.BUILD_URL}console
                """,
                to: 'devops@example.com',
                from: 'jenkins@example.com'
            )
        }
        always {
            // Clean up Jenkins workspace
            cleanWs()
            
            // Archive Docker logs
            script {
                sh '''
                    docker logs ${CONTAINER_NAME} > docker-logs.txt 2>&1 || true
                '''
                archiveArtifacts artifacts: 'docker-logs.txt', fingerprint: true
            }
        }
    }
}